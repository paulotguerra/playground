import React, { useState, useEffect } from 'react';
import { Car, Calculator, Info, TrendingDown, CheckCircle2, Banknote, FileText, Shield, Wrench } from 'lucide-react';

// --- COMPONENTES AUXILIARES ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden ${className}`}>
    {children}
  </div>
);

// Função para formatar BRL (R$ 1.234,56)
const formatCurrency = (value) => {
  if (value === undefined || value === null) return 'R$ 0,00';
  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
};

// Lista de Estados
const ESTADOS_IPVA = [
  { sigla: 'AC', taxa: 2.0 }, { sigla: 'AL', taxa: 3.0 }, { sigla: 'AP', taxa: 3.0 },
  { sigla: 'AM', taxa: 3.0 }, { sigla: 'BA', taxa: 2.5 }, { sigla: 'CE', taxa: 3.0 },
  { sigla: 'DF', taxa: 3.5 }, { sigla: 'ES', taxa: 2.0 }, { sigla: 'GO', taxa: 3.75 },
  { sigla: 'MA', taxa: 2.5 }, { sigla: 'MT', taxa: 3.0 }, { sigla: 'MS', taxa: 3.0 },
  { sigla: 'MG', taxa: 4.0 }, { sigla: 'PA', taxa: 2.5 }, { sigla: 'PB', taxa: 2.5 },
  { sigla: 'PR', taxa: 3.5 }, { sigla: 'PE', taxa: 3.0 }, { sigla: 'PI', taxa: 3.0 },
  { sigla: 'RJ', taxa: 4.0 }, { sigla: 'RN', taxa: 3.0 }, { sigla: 'RS', taxa: 3.0 },
  { sigla: 'RO', taxa: 3.0 }, { sigla: 'RR', taxa: 3.0 }, { sigla: 'SC', taxa: 2.0 },
  { sigla: 'SP', taxa: 4.0 }, { sigla: 'SE', taxa: 2.5 }, { sigla: 'TO', taxa: 2.0 },
];

export default function App() {
  // --- ESTADO ---
  const [inputs, setInputs] = useState({
    modelo: 'Fiat Fastback',
    valorCompra: 119990,
    valorAssinatura: 2550,
    tempoMeses: 18,
    estado: 'CE',
    entrada: 119990,
    
    // Uso
    kmMensal: 1000,
    
    // Financeiro
    taxaFinanciamentoMensal: 1.49,
    rendimentoMensal: 0.85,
    
    // Custos Editáveis (Valores em Reais)
    seguroAnualReais: 0,     // Será calculado no useEffect
    manutencaoAnualReais: 0, // Será calculado no useEffect
    ipvaAnualReais: 0,       // Será calculado no useEffect
    valorRevendaReais: 0,    // Será calculado no useEffect
    
    // Parâmetros de base
    depreciacaoAnualPercent: 12, // Usado apenas para sugerir o valor de revenda
    
    // Documentação
    emplacamento: 800, // Custo único
    licenciamentoAnual: 180, // Custo recorrente
  });

  const [resultados, setResultados] = useState(null);

  // --- AUTO-CÁLCULO DOS CAMPOS EDITÁVEIS ---
  
  // 1. Atualiza Seguro (2% padrão) e IPVA quando valor do carro ou estado mudam
  useEffect(() => {
    const valor = Number(inputs.valorCompra) || 0;
    const estadoInfo = ESTADOS_IPVA.find(e => e.sigla === inputs.estado) || { taxa: 3.0 };
    
    // Seguro estimado: 2% do valor inicial
    const novoSeguro = valor * 0.02;
    
    // IPVA estimado: Taxa do estado sobre valor inicial
    const novoIpva = valor * (estadoInfo.taxa / 100);

    setInputs(prev => ({
      ...prev,
      seguroAnualReais: novoSeguro,
      ipvaAnualReais: novoIpva
    }));
  }, [inputs.valorCompra, inputs.estado]);

  // 2. Atualiza Manutenção baseada na KM Mensal (Tabela base Fiat ~ R$ 950 a cada 10.000km)
  useEffect(() => {
    const kmAnual = (Number(inputs.kmMensal) || 0) * 12;
    // Custo estimado: (KmAnual / 10.000) * Custo Médio Revisão + Desgaste (R$ 950)
    const custoManutencao = (kmAnual / 10000) * 950;
    
    setInputs(prev => ({
      ...prev,
      manutencaoAnualReais: Math.round(custoManutencao)
    }));
  }, [inputs.kmMensal]);

  // 3. Atualiza Valor de Revenda Sugerido quando preço, tempo ou taxa de depreciação mudam
  useEffect(() => {
    const valor = Number(inputs.valorCompra) || 0;
    const anos = (Number(inputs.tempoMeses) || 0) / 12;
    const taxaDep = (Number(inputs.depreciacaoAnualPercent) || 0) / 100;
    
    const revendaEstimada = valor * Math.pow((1 - taxaDep), anos);
    
    setInputs(prev => ({
      ...prev,
      valorRevendaReais: Math.round(revendaEstimada)
    }));
  }, [inputs.valorCompra, inputs.tempoMeses, inputs.depreciacaoAnualPercent]);


  // --- HANDLERS ---

  const handleBasicChange = (e) => {
    const { name, value } = e.target;
    setInputs(prev => ({
      ...prev,
      [name]: value === '' ? '' : value
    }));
  };

  const handleMoneyChange = (e) => {
    const { name, value } = e.target;
    const onlyDigits = value.replace(/\D/g, '');
    const numericValue = Number(onlyDigits) / 100;
    setInputs(prev => ({
      ...prev,
      [name]: numericValue
    }));
  };

  const getDisplayValue = (key) => {
    const val = inputs[key];
    if (val === '' || val === undefined) return '';
    return formatCurrency(val).replace('R$', '').trim();
  };

  // --- CÁLCULO FINAL ---

  const calcular = () => {
    const safeInputs = { ...inputs };
    Object.keys(safeInputs).forEach(key => {
      if (safeInputs[key] === '') safeInputs[key] = 0;
    });

    const {
      valorCompra, valorAssinatura, tempoMeses,
      entrada, taxaFinanciamentoMensal,
      seguroAnualReais, manutencaoAnualReais, ipvaAnualReais, valorRevendaReais,
      emplacamento, licenciamentoAnual,
      rendimentoMensal
    } = safeInputs;

    const tempoAnos = Number(tempoMeses) / 12;

    // --- CENÁRIO A: COMPRAR ---
    
    // 1. Financiamento
    const valorFinanciado = valorCompra - entrada;
    let totalPagoCarro = Number(entrada);
    
    if (valorFinanciado > 0) {
      const taxa = Number(taxaFinanciamentoMensal) / 100;
      const parcela = valorFinanciado * (taxa * Math.pow(1 + taxa, tempoMeses)) / (Math.pow(1 + taxa, tempoMeses) - 1);
      totalPagoCarro += (parcela * tempoMeses);
    }

    // 2. Custos Correntes (com depreciação implícita)
    let somaIPVA = 0;
    let somaSeguro = 0;
    let somaManutencao = 0;
    let somaLicenciamento = 0;
    
    let valorBaseCalculo = Number(valorCompra); 
    const valorIpvaBaseInput = Number(ipvaAnualReais);
    const valorSeguroBaseInput = Number(seguroAnualReais);
    
    const taxaIpvaImplicita = valorCompra > 0 ? valorIpvaBaseInput / valorCompra : 0;
    const taxaSeguroImplicita = valorCompra > 0 ? valorSeguroBaseInput / valorCompra : 0;
    const depRate = inputs.depreciacaoAnualPercent / 100;

    for (let ano = 1; ano <= Math.ceil(tempoAnos); ano++) {
      const mesesNoAno = (ano * 12 > tempoMeses) ? (tempoMeses % 12 || 12) : 12;
      const fatorAno = mesesNoAno / 12;

      somaIPVA += (valorBaseCalculo * taxaIpvaImplicita) * fatorAno;
      somaSeguro += (valorBaseCalculo * taxaSeguroImplicita) * fatorAno;
      somaManutencao += Number(manutencaoAnualReais) * fatorAno;
      somaLicenciamento += Number(licenciamentoAnual) * fatorAno;

      valorBaseCalculo = valorBaseCalculo * (1 - depRate);
    }

    const valorFinalRevenda = Number(valorRevendaReais);

    // 4. Custo Oportunidade
    const montanteEntradaInvestida = Number(entrada) * Math.pow((1 + rendimentoMensal/100), tempoMeses);
    const custoOportunidadeEntrada = montanteEntradaInvestida - Number(entrada);

    const custosTotais = totalPagoCarro + somaIPVA + somaSeguro + somaManutencao + Number(emplacamento) + somaLicenciamento + custoOportunidadeEntrada;
    const custoTotalCompra = custosTotais - valorFinalRevenda;


    // --- CENÁRIO B: ASSINAR ---
    const totalAssinatura = Number(valorAssinatura) * Number(tempoMeses);
    const montanteCapitalPreservado = Number(entrada) * Math.pow((1 + rendimentoMensal/100), tempoMeses);
    const rendimentoCapital = montanteCapitalPreservado - Number(entrada);
    const custoTotalAssinatura = totalAssinatura - rendimentoCapital;

    setResultados({
      compra: {
        custoFinal: custoTotalCompra,
        revenda: valorFinalRevenda,
        oportunidade: custoOportunidadeEntrada,
        ipva: somaIPVA,
        seguro: somaSeguro,
        manutencao: somaManutencao,
        emplacamento: Number(emplacamento),
        licenciamento: somaLicenciamento
      },
      assinatura: {
        custoFinal: custoTotalAssinatura,
        totalPago: totalAssinatura,
        rendimento: rendimentoCapital
      },
      melhorOpcao: custoTotalCompra < custoTotalAssinatura ? 'COMPRA' : 'ASSINATURA',
      diferenca: Math.abs(custoTotalCompra - custoTotalAssinatura)
    });
  };

  const getBarWidth = (val1, val2) => {
    const max = Math.max(val1, val2);
    if (max === 0) return { w1: 0, w2: 0 };
    return { w1: (val1 / max) * 100, w2: (val2 / max) * 100 };
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-12">
      {/* Header */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-8 px-4 shadow-lg">
        <div className="max-w-5xl mx-auto">
          <div className="flex items-center gap-3 mb-2">
            <Car className="w-8 h-8" />
            <h1 className="text-2xl md:text-3xl font-bold">Comprar ou Assinar?</h1>
          </div>
          <p className="text-blue-100 opacity-90">Calculadora Financeira de Veículos</p>
        </div>
      </div>

      <main className="max-w-5xl mx-auto px-4 -mt-6 grid grid-cols-1 md:grid-cols-12 gap-6">
        
        {/* --- INPUTS --- */}
        <div className="md:col-span-5 space-y-4">
          <Card className="p-5">
            <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
              <Calculator className="w-5 h-5 text-blue-600" />
              Parâmetros
            </h2>
            
            <div className="space-y-4">
              {/* Modelo */}
              <div>
                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Modelo</label>
                <input type="text" name="modelo" value={inputs.modelo} onChange={handleBasicChange} className="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none" />
              </div>

              {/* Preço e Assinatura Lado a Lado */}
              <div className="grid grid-cols-2 gap-3">
                <div>
                    <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Valor Compra</label>
                    <div className="relative">
                    <span className="absolute left-2 top-2 text-gray-500 text-sm">R$</span>
                    <input type="text" name="valorCompra" value={getDisplayValue('valorCompra')} onChange={handleMoneyChange} className="w-full pl-7 p-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none font-medium text-sm" />
                    </div>
                </div>
                <div>
                    <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Valor Assinatura</label>
                    <div className="relative">
                    <span className="absolute left-2 top-2 text-gray-500 text-sm">R$</span>
                    <input type="text" name="valorAssinatura" value={getDisplayValue('valorAssinatura')} onChange={handleMoneyChange} className="w-full pl-7 p-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none font-medium text-sm" />
                    </div>
                </div>
              </div>

              {/* Tempo, Estado, Km */}
              <div className="grid grid-cols-3 gap-2">
                <div>
                  <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Meses</label>
                  <input type="number" name="tempoMeses" value={inputs.tempoMeses} onChange={handleBasicChange} className="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none text-sm" />
                </div>
                <div>
                  <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Estado</label>
                  <select name="estado" value={inputs.estado} onChange={handleBasicChange} className="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none bg-white text-sm" >
                    {ESTADOS_IPVA.map(e => (<option key={e.sigla} value={e.sigla}>{e.sigla}</option>))}
                  </select>
                </div>
                <div>
                  <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Km/Mês</label>
                  <input type="number" name="kmMensal" value={inputs.kmMensal} onChange={handleBasicChange} className="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none text-sm" />
                </div>
              </div>

              <div className="border-t border-gray-100 my-2 pt-2">
                {/* Entrada */}
                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Sua Entrada (Capital disponível)</label>
                <div className="relative">
                  <span className="absolute left-3 top-2 text-gray-500">R$</span>
                  <input type="text" name="entrada" value={getDisplayValue('entrada')} onChange={handleMoneyChange} className="w-full pl-9 p-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none font-medium" />
                </div>
              </div>

              {/* Taxas */}
              <div className="grid grid-cols-2 gap-3 bg-gray-50 p-2 rounded border border-gray-100">
                {inputs.entrada < inputs.valorCompra && (
                  <div>
                    <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Juros Financ. (% a.m)</label>
                    <input type="number" name="taxaFinanciamentoMensal" value={inputs.taxaFinanciamentoMensal} onChange={handleBasicChange} className="w-full p-1 border border-gray-300 rounded focus:border-blue-500 outline-none text-sm" />
                  </div>
                )}
                <div>
                  <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Rend. Invest. (% a.m)</label>
                  <input type="number" name="rendimentoMensal" value={inputs.rendimentoMensal} onChange={handleBasicChange} className="w-full p-1 border border-gray-300 rounded focus:border-blue-500 outline-none text-sm" />
                </div>
              </div>

              {/* Custos Editáveis */}
              <div className="space-y-3 pt-2">
                  <h3 className="text-xs font-bold text-slate-700 uppercase border-b pb-1">Estimativas Editáveis (Valores Anuais/Totais)</h3>
                  
                  <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="block text-[10px] font-bold mb-1 text-gray-600">Seguro Anual (R$)</label>
                        <div className="relative">
                             <span className="absolute left-2 top-1.5 text-gray-500 text-xs">R$</span>
                            <input type="text" name="seguroAnualReais" value={getDisplayValue('seguroAnualReais')} onChange={handleMoneyChange} className="w-full pl-6 p-1.5 border rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none bg-blue-50/50" />
                        </div>
                        <p className="text-[9px] text-gray-400 mt-0.5">Inicial: 2% do valor</p>
                      </div>
                      <div>
                        <label className="block text-[10px] font-bold mb-1 text-gray-600">IPVA Anual (R$)</label>
                        <div className="relative">
                             <span className="absolute left-2 top-1.5 text-gray-500 text-xs">R$</span>
                             <input type="text" name="ipvaAnualReais" value={getDisplayValue('ipvaAnualReais')} onChange={handleMoneyChange} className="w-full pl-6 p-1.5 border rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none bg-blue-50/50" />
                        </div>
                        <p className="text-[9px] text-gray-400 mt-0.5">Baseado no Estado</p>
                      </div>
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="block text-[10px] font-bold mb-1 text-gray-600">Manutenção Anual (R$)</label>
                         <div className="relative">
                             <span className="absolute left-2 top-1.5 text-gray-500 text-xs">R$</span>
                             <input type="text" name="manutencaoAnualReais" value={getDisplayValue('manutencaoAnualReais')} onChange={handleMoneyChange} className="w-full pl-6 p-1.5 border rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none bg-blue-50/50" />
                        </div>
                        <p className="text-[9px] text-gray-400 mt-0.5">Estimado por Km</p>
                      </div>
                      <div>
                        <label className="block text-[10px] font-bold mb-1 text-gray-600">Valor Revenda Final (R$)</label>
                         <div className="relative">
                             <span className="absolute left-2 top-1.5 text-gray-500 text-xs">R$</span>
                             <input type="text" name="valorRevendaReais" value={getDisplayValue('valorRevendaReais')} onChange={handleMoneyChange} className="w-full pl-6 p-1.5 border rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none bg-blue-50/50" />
                        </div>
                        <p className="text-[9px] text-gray-400 mt-0.5">Calculado c/ dep. {inputs.depreciacaoAnualPercent}%</p>
                      </div>
                  </div>

                  <details className="text-xs text-gray-500 pt-2">
                      <summary className="cursor-pointer hover:text-blue-600">Editar Custos Documentação</summary>
                      <div className="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <label className="block text-[9px] font-bold mb-1">Emplacamento (Único)</label>
                            <input type="text" name="emplacamento" value={getDisplayValue('emplacamento')} onChange={handleMoneyChange} className="w-full p-1 border rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
                        </div>
                        <div>
                            <label className="block text-[9px] font-bold mb-1">Licenciamento (Anual)</label>
                            <input type="text" name="licenciamentoAnual" value={getDisplayValue('licenciamentoAnual')} onChange={handleMoneyChange} className="w-full p-1 border rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
                        </div>
                         <div>
                            <label className="block text-[9px] font-bold mb-1">Taxa Depreciação (%)</label>
                            <input type="number" name="depreciacaoAnualPercent" value={inputs.depreciacaoAnualPercent} onChange={handleBasicChange} className="w-full p-1 border rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
                        </div>
                      </div>
                  </details>
              </div>

              {/* Botão Calcular */}
              <button 
                onClick={calcular}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform active:scale-95 flex justify-center items-center gap-2"
              >
                <Calculator className="w-5 h-5" />
                CALCULAR RESULTADOS
              </button>

            </div>
          </Card>
        </div>

        {/* --- RESULTADOS --- */}
        <div className="md:col-span-7 space-y-6">
          
          {!resultados ? (
            <div className="h-full flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-200 rounded-xl p-10 min-h-[400px]">
              <Car className="w-16 h-16 mb-4 opacity-20" />
              <p className="text-lg font-medium text-center">
                  Simule seus gastos.<br/>Preencha e clique em Calcular.
              </p>
            </div>
          ) : (
  